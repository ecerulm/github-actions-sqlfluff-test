name: linting
on:
    pull_request:
        branches: [ "main" ]

    workflow_dispatch:
jobs:
    sqlfluff-lint-annotations-native:
        runs-on: ubuntu-latest
        permissions:
          contents: read
          pull-requests: write 

        steps:
            - uses: actions/checkout@v4
            - run: pip install 'sqlfluff==3.4.0' 
            - run: git fetch --depth=1 origin main:main
            - name: Run sqlfluff linter with github native annotations
              run: |
                sqlfluff lint -f github-annotation-native $(git diff --name-only ${{ github.base_ref }})

            - name: Print Pull Request URL
              run: |
                echo "The Pull Request URL is: ${{ github.event.pull_request.html_url }}"
                echo "The Pull Request Number is: ${{ github.event.pull_request.number }}"


            - name: Add a comment to the PR with the result
              run: |
                # GitHub CLI api
                # https://cli.github.com/manual/gh_api

                gh api \
                --method POST \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                /repos/OWNER/REPO/pulls/PULL_NUMBER/comments \
                -f "body=Great stuff!" -f "commit_id=6dcb09b5b57875f334f61aebed695e2e4193db5e" -f "path=file1.txt" -F "start_line=1" -f "start_side=RIGHT" -F "line=2" -f "side=RIGHT"
